<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>SmartEMR Autocomplete Tailwind</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen flex justify-center py-12">

<div class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-8">

  <h2 class="text-2xl font-bold text-blue-700 mb-6">
    ðŸ§  MaiDiSe Autocomplete â€“ ICD + ATC
  </h2>

  <!-- Input row -->
  <div class="flex gap-3 mb-4">
    
    <select id="type"
            class="px-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-400">
      <option value="icd">ICD-11</option>
      <option value="atc">ATC / Thuá»‘c</option>
    </select>

    <input id="search"
           placeholder="Nháº­p tÃªn bá»‡nh / thuá»‘c..."
           class="flex-1 px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-400" />

    <button id="clearCache"
            class="px-4 py-2 bg-red-500 text-white rounded-lg shadow hover:bg-red-600 font-semibold">
      ðŸ§¹ XÃ³a cache
    </button>
  </div>

  <!-- Info -->
  <div id="info" class="text-sm text-gray-500 mb-2"></div>

  <!-- Results -->
  <ul id="results"
      class="divide-y divide-gray-200 border rounded-xl bg-white shadow max-h-96 overflow-y-auto">
  </ul>

</div>


<script>
const search = document.getElementById("search");
const type = document.getElementById("type");
const results = document.getElementById("results");
const info = document.getElementById("info");

let timer;

// debounce input
search.addEventListener("input", () => {
  clearTimeout(timer);
  timer = setTimeout(runAutocomplete, 200);
});

async function runAutocomplete() {
  let q = search.value.trim();
  if (!q) { results.innerHTML = ""; info.innerHTML = ""; return; }

  let mode = type.value;

  const res = await fetch(
    `http://127.0.0.1:5000/autocomplete?q=${encodeURIComponent(q)}&type=${mode}`
  );
  const data = await res.json();

  info.textContent = `â± ${data.latency_ms} ms â€¢ Source: ${data.source} â€¢ ${data.results.length} káº¿t quáº£`;

  results.innerHTML = data.results
    .map(r => `
      <li class="p-3 hover:bg-blue-50 cursor-pointer">
        <div class="flex justify-between">
          <span class="font-semibold text-blue-700">${r.code}</span>
          <span class="text-gray-500 text-sm">${r.type}</span>
        </div>
        <div class="text-gray-900">${r.label}</div>
        ${r.forms?.length ? 
            `<div class="text-sm text-gray-600 mt-1">${r.forms.join(", ")}</div>` 
        : "" }
      </li>
    `)
    .join("");
}

// clear cache
document.getElementById("clearCache").onclick = async () => {
  const res = await fetch("http://127.0.0.1:5000/clear_cache", { method: "POST" });
  const data = await res.json();

  info.innerHTML = `ðŸ§¹ Cache cleared â€¢ ICD=${data.cleared_icd} â€¢ ATC=${data.cleared_atc}`;
  results.innerHTML = "";
  search.value = "";
};
</script>

</body>
</html>
